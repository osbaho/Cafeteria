<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Seguridad XSS - Cafeter√≠a Virtual</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        .test-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-case {
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 10px 0;
            background: #f9f9f9;
        }
        .test-case h3 {
            margin-top: 0;
            color: #333;
        }
        .test-result {
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px 10px 0;
        }
        button:hover {
            background: #764ba2;
        }
        .code {
            background: #282c34;
            color: #abb2bf;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
        }
        .summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .summary h2 {
            margin-top: 0;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stat-box {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üîí Suite de Pruebas de Seguridad XSS</h1>
    <p>Esta herramienta prueba las capas de seguridad implementadas en la Cafeter√≠a Virtual contra ataques XSS (Cross-Site Scripting).</p>

    <div class="summary" id="summary">
        <h2>üìä Resumen de Pruebas</h2>
        <div class="stats">
            <div class="stat-box">
                <div class="stat-number" id="total-tests">0</div>
                <div>Total de Pruebas</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="passed-tests">0</div>
                <div>‚úÖ Aprobadas</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="failed-tests">0</div>
                <div>‚ùå Falladas</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="warning-tests">0</div>
                <div>‚ö†Ô∏è Advertencias</div>
            </div>
        </div>
    </div>

    <button onclick="runAllTests()">‚ñ∂Ô∏è Ejecutar Todas las Pruebas</button>
    <button onclick="clearResults()">üóëÔ∏è Limpiar Resultados</button>

    <div class="test-section">
        <h2>üõ°Ô∏è Capa 1: Content Security Policy (CSP)</h2>
        <p>Verifica que las pol√≠ticas de seguridad de contenido est√©n correctamente configuradas.</p>
        <div id="csp-tests"></div>
    </div>

    <div class="test-section">
        <h2>üîê Capa 2: Manipulaci√≥n Segura del DOM</h2>
        <p>Prueba que no se use innerHTML con contenido din√°mico y que se utilice textContent/createElement.</p>
        <div id="dom-tests"></div>
    </div>

    <div class="test-section">
        <h2>üö´ Capa 3: Vectores de Ataque XSS</h2>
        <p>Intenta inyectar scripts maliciosos usando vectores comunes de XSS.</p>
        <div id="xss-tests"></div>
    </div>

    <div class="test-section">
        <h2>üîç Capa 4: Seguridad de Headers HTTP</h2>
        <p>Verifica la presencia de headers de seguridad en la aplicaci√≥n.</p>
        <div id="header-tests"></div>
    </div>

    <script>
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            warnings: 0
        };

        function updateSummary() {
            document.getElementById('total-tests').textContent = testResults.total;
            document.getElementById('passed-tests').textContent = testResults.passed;
            document.getElementById('failed-tests').textContent = testResults.failed;
            document.getElementById('warning-tests').textContent = testResults.warnings;
        }

        function addTestResult(containerId, testName, passed, message, isWarning = false) {
            testResults.total++;
            if (passed) {
                testResults.passed++;
            } else if (isWarning) {
                testResults.warnings++;
            } else {
                testResults.failed++;
            }

            const container = document.getElementById(containerId);
            const testCase = document.createElement('div');
            testCase.className = 'test-case';
            
            const testTitle = document.createElement('h3');
            testTitle.textContent = testName;
            testCase.appendChild(testTitle);

            const result = document.createElement('div');
            result.className = `test-result ${passed ? 'pass' : (isWarning ? 'warning' : 'fail')}`;
            result.textContent = message;
            testCase.appendChild(result);

            container.appendChild(testCase);
            updateSummary();
        }

        async function testCSPHeaders() {
            const container = document.getElementById('csp-tests');
            container.innerHTML = '';

            // Test 1: Check if CSP meta tag exists
            const cspMeta = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
            if (cspMeta) {
                const cspContent = cspMeta.getAttribute('content');
                addTestResult('csp-tests', 
                    'Presencia de CSP Meta Tag', 
                    true, 
                    `‚úÖ CSP Meta Tag encontrado: ${cspContent.substring(0, 50)}...`
                );

                // Test 2: Check if script-src is restrictive
                if (cspContent.includes("script-src 'self'")) {
                    addTestResult('csp-tests', 
                        'Restricci√≥n de Scripts', 
                        true, 
                        "‚úÖ Scripts restringidos a 'self' (solo del mismo origen)"
                    );
                } else {
                    addTestResult('csp-tests', 
                        'Restricci√≥n de Scripts', 
                        false, 
                        "‚ö†Ô∏è Scripts no est√°n suficientemente restringidos",
                        true
                    );
                }

                // Test 3: Check if object-src is none
                if (cspContent.includes("object-src 'none'")) {
                    addTestResult('csp-tests', 
                        'Bloqueo de Plugins', 
                        true, 
                        "‚úÖ Plugins (Flash, Java) bloqueados con object-src 'none'"
                    );
                }

                // Test 4: Check if frame-src is none
                if (cspContent.includes("frame-src 'none'")) {
                    addTestResult('csp-tests', 
                        'Protecci√≥n contra Clickjacking', 
                        true, 
                        "‚úÖ Frames externos bloqueados para prevenir clickjacking"
                    );
                }
            } else {
                addTestResult('csp-tests', 
                    'Presencia de CSP Meta Tag', 
                    false, 
                    "‚ùå No se encontr√≥ Content Security Policy"
                );
            }

            // Test 5: X-Content-Type-Options
            const xContentType = document.querySelector('meta[http-equiv="X-Content-Type-Options"]');
            if (xContentType && xContentType.getAttribute('content') === 'nosniff') {
                addTestResult('csp-tests', 
                    'X-Content-Type-Options', 
                    true, 
                    "‚úÖ Header X-Content-Type-Options: nosniff configurado"
                );
            } else {
                addTestResult('csp-tests', 
                    'X-Content-Type-Options', 
                    false, 
                    "‚ùå X-Content-Type-Options no configurado"
                );
            }

            // Test 6: X-Frame-Options
            const xFrameOptions = document.querySelector('meta[http-equiv="X-Frame-Options"]');
            if (xFrameOptions && xFrameOptions.getAttribute('content') === 'DENY') {
                addTestResult('csp-tests', 
                    'X-Frame-Options', 
                    true, 
                    "‚úÖ Header X-Frame-Options: DENY configurado"
                );
            } else {
                addTestResult('csp-tests', 
                    'X-Frame-Options', 
                    false, 
                    "‚ùå X-Frame-Options no configurado"
                );
            }

            // Test 7: X-XSS-Protection
            const xXSSProtection = document.querySelector('meta[http-equiv="X-XSS-Protection"]');
            if (xXSSProtection) {
                addTestResult('csp-tests', 
                    'X-XSS-Protection', 
                    true, 
                    "‚úÖ Header X-XSS-Protection configurado"
                );
            } else {
                addTestResult('csp-tests', 
                    'X-XSS-Protection', 
                    false, 
                    "‚ùå X-XSS-Protection no configurado"
                );
            }
        }

        async function testDOMManipulation() {
            const container = document.getElementById('dom-tests');
            container.innerHTML = '';

            // Load index.html source to check
            try {
                const response = await fetch('index.html');
                const htmlContent = await response.text();

                // Test 1: Check for innerHTML with dynamic content
                const dangerousPatterns = [
                    /innerHTML\s*=\s*[^'"`]*\$\{/g,
                    /innerHTML\s*=\s*[^'"`]*\+/g,
                ];

                let foundDangerous = false;
                for (const pattern of dangerousPatterns) {
                    if (pattern.test(htmlContent)) {
                        foundDangerous = true;
                        break;
                    }
                }

                if (!foundDangerous) {
                    addTestResult('dom-tests', 
                        'innerHTML con Contenido Din√°mico', 
                        true, 
                        "‚úÖ No se encontr√≥ uso peligroso de innerHTML con contenido din√°mico"
                    );
                } else {
                    addTestResult('dom-tests', 
                        'innerHTML con Contenido Din√°mico', 
                        false, 
                        "‚ùå Se encontr√≥ uso potencialmente peligroso de innerHTML"
                    );
                }

                // Test 2: Check for createElement usage
                if (htmlContent.includes('createElement')) {
                    addTestResult('dom-tests', 
                        'Uso de createElement', 
                        true, 
                        "‚úÖ Se utiliza createElement para manipulaci√≥n segura del DOM"
                    );
                } else {
                    addTestResult('dom-tests', 
                        'Uso de createElement', 
                        false, 
                        "‚ö†Ô∏è No se encontr√≥ uso de createElement",
                        true
                    );
                }

                // Test 3: Check for textContent usage
                if (htmlContent.includes('textContent')) {
                    addTestResult('dom-tests', 
                        'Uso de textContent', 
                        true, 
                        "‚úÖ Se utiliza textContent para asignar texto de forma segura"
                    );
                } else {
                    addTestResult('dom-tests', 
                        'Uso de textContent', 
                        false, 
                        "‚ö†Ô∏è No se encontr√≥ uso de textContent",
                        true
                    );
                }

                // Test 4: Check for eval usage
                if (!htmlContent.includes('eval(') && !htmlContent.includes('eval ')) {
                    addTestResult('dom-tests', 
                        'Ausencia de eval()', 
                        true, 
                        "‚úÖ No se utiliza eval() - excelente pr√°ctica de seguridad"
                    );
                } else {
                    addTestResult('dom-tests', 
                        'Ausencia de eval()', 
                        false, 
                        "‚ùå Se encontr√≥ uso de eval() - alto riesgo de seguridad"
                    );
                }

                // Test 5: Check for Function constructor
                if (!htmlContent.match(/new\s+Function\s*\(/)) {
                    addTestResult('dom-tests', 
                        'Ausencia de Function Constructor', 
                        true, 
                        "‚úÖ No se utiliza new Function() - buena pr√°ctica"
                    );
                } else {
                    addTestResult('dom-tests', 
                        'Ausencia de Function Constructor', 
                        false, 
                        "‚ùå Se encontr√≥ uso de new Function() - riesgo de seguridad"
                    );
                }

                // Test 6: Check for setAttribute with event handlers
                const attrPattern = /setAttribute\s*\(\s*['"]on\w+['"]/g;
                if (!attrPattern.test(htmlContent)) {
                    addTestResult('dom-tests', 
                        'Event Handlers Seguros', 
                        true, 
                        "‚úÖ No se asignan event handlers mediante setAttribute - buena pr√°ctica"
                    );
                } else {
                    addTestResult('dom-tests', 
                        'Event Handlers Seguros', 
                        false, 
                        "‚ö†Ô∏è Se encontr√≥ asignaci√≥n de event handlers con setAttribute",
                        true
                    );
                }

            } catch (error) {
                addTestResult('dom-tests', 
                    'An√°lisis de C√≥digo', 
                    false, 
                    "‚ùå Error al cargar index.html para an√°lisis: " + error.message
                );
            }
        }

        function testXSSVectors() {
            const container = document.getElementById('xss-tests');
            container.innerHTML = '';

            // Common XSS attack vectors
            const xssVectors = [
                '<script>alert("XSS")</script>',
                '<img src=x onerror=alert("XSS")>',
                '<svg onload=alert("XSS")>',
                'javascript:alert("XSS")',
                '<iframe src="javascript:alert(\'XSS\')">',
                '"><script>alert(String.fromCharCode(88,83,83))</script>',
                '<body onload=alert("XSS")>',
                '<input type="text" value="XSS" onfocus=alert(document.cookie)>',
            ];

            // Test each vector by trying to create elements
            let allBlocked = true;
            xssVectors.forEach((vector, index) => {
                try {
                    const testDiv = document.createElement('div');
                    testDiv.textContent = vector; // Safe assignment
                    
                    // If textContent is used correctly, the script won't execute
                    if (testDiv.textContent === vector) {
                        addTestResult('xss-tests', 
                            `Vector XSS ${index + 1}: ${vector.substring(0, 30)}...`, 
                            true, 
                            "‚úÖ Vector bloqueado - contenido escapado correctamente"
                        );
                    } else {
                        allBlocked = false;
                        addTestResult('xss-tests', 
                            `Vector XSS ${index + 1}`, 
                            false, 
                            "‚ùå Vector NO bloqueado - posible vulnerabilidad"
                        );
                    }
                } catch (error) {
                    addTestResult('xss-tests', 
                        `Vector XSS ${index + 1}`, 
                        true, 
                        "‚úÖ Vector bloqueado por excepci√≥n: " + error.message
                    );
                }
            });

            // Test DOM-based XSS
            const urlParams = new URLSearchParams(window.location.search);
            if (!urlParams.has('xss_test')) {
                addTestResult('xss-tests', 
                    'Protecci√≥n contra XSS basado en URL', 
                    true, 
                    "‚úÖ No se procesan par√°metros de URL sin validaci√≥n"
                );
            }
        }

        function testHTTPHeaders() {
            const container = document.getElementById('header-tests');
            container.innerHTML = '';

            // These would typically be checked on the server response
            // Here we check for meta equivalents
            const securityHeaders = [
                {
                    name: 'Content-Security-Policy',
                    selector: 'meta[http-equiv="Content-Security-Policy"]'
                },
                {
                    name: 'X-Content-Type-Options',
                    selector: 'meta[http-equiv="X-Content-Type-Options"]'
                },
                {
                    name: 'X-Frame-Options',
                    selector: 'meta[http-equiv="X-Frame-Options"]'
                },
                {
                    name: 'X-XSS-Protection',
                    selector: 'meta[http-equiv="X-XSS-Protection"]'
                },
                {
                    name: 'Referrer Policy',
                    selector: 'meta[name="referrer"]'
                }
            ];

            securityHeaders.forEach(header => {
                const element = document.querySelector(header.selector);
                if (element) {
                    addTestResult('header-tests', 
                        header.name, 
                        true, 
                        `‚úÖ ${header.name} configurado correctamente`
                    );
                } else {
                    addTestResult('header-tests', 
                        header.name, 
                        false, 
                        `‚ö†Ô∏è ${header.name} no encontrado`,
                        true
                    );
                }
            });

            // Test for HTTPS enforcement
            if (window.location.protocol === 'https:') {
                addTestResult('header-tests', 
                    'Conexi√≥n HTTPS', 
                    true, 
                    "‚úÖ Aplicaci√≥n servida mediante HTTPS"
                );
            } else {
                addTestResult('header-tests', 
                    'Conexi√≥n HTTPS', 
                    false, 
                    "‚ö†Ô∏è Aplicaci√≥n no est√° en HTTPS (solo en producci√≥n)",
                    true
                );
            }
        }

        function runAllTests() {
            clearResults();
            console.log('üîí Iniciando Suite de Pruebas de Seguridad XSS...');
            
            testCSPHeaders();
            testDOMManipulation();
            testXSSVectors();
            testHTTPHeaders();

            console.log('‚úÖ Pruebas completadas!');
            console.log(`Total: ${testResults.total}, Aprobadas: ${testResults.passed}, Falladas: ${testResults.failed}, Advertencias: ${testResults.warnings}`);
        }

        function clearResults() {
            testResults = { total: 0, passed: 0, failed: 0, warnings: 0 };
            document.getElementById('csp-tests').innerHTML = '';
            document.getElementById('dom-tests').innerHTML = '';
            document.getElementById('xss-tests').innerHTML = '';
            document.getElementById('header-tests').innerHTML = '';
            updateSummary();
        }

        // Run tests on page load
        window.addEventListener('DOMContentLoaded', () => {
            console.log('üìã Suite de Pruebas de Seguridad XSS cargada');
            console.log('Haz clic en "Ejecutar Todas las Pruebas" para comenzar');
        });
    </script>
</body>
</html>
