<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Functional Tests - Virtual Cafeteria</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        .test-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-case {
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 10px 0;
            background: #f9f9f9;
        }
        .test-case h3 {
            margin-top: 0;
            color: #333;
        }
        .test-result {
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px 10px 0;
        }
        button:hover {
            background: #764ba2;
        }
        .summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .summary h2 {
            margin-top: 0;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stat-box {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª Functional Test Suite</h1>
    <p>This tool tests all main features of the Virtual Cafeteria.</p>

    <div class="summary" id="summary">
        <h2>ğŸ“Š Test Summary</h2>
        <div class="stats">
            <div class="stat-box">
                <div class="stat-number" id="total-tests">0</div>
                <div>Total Tests</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="passed-tests">0</div>
                <div>âœ… Passed</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="failed-tests">0</div>
                <div>âŒ Failed</div>
            </div>
        </div>
    </div>

    <button onclick="runAllTests()">â–¶ï¸ Run All Tests</button>
    <button onclick="clearResults()">ğŸ—‘ï¸ Clear Results</button>

    <div class="test-section">
        <h2>ğŸ›’ Cart Management</h2>
        <p>Tests shopping cart operations.</p>
        <div id="cart-tests"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ’° Calculations and Totals</h2>
        <p>Verifies that price calculations are correct.</p>
        <div id="calculation-tests"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ’³ Payment Methods</h2>
        <p>Tests payment method selection.</p>
        <div id="payment-tests"></div>
    </div>

    <div class="test-section">
        <h2>âœ… Checkout Process</h2>
        <p>Verifies the complete order completion process.</p>
        <div id="checkout-tests"></div>
    </div>

    <script>
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0
        };

        // Open index.html in an iframe for testing
        let testFrame;

        function setupTestFrame() {
            // Clean up existing iframe
            if (testFrame) {
                document.body.removeChild(testFrame);
            }
            
            testFrame = document.createElement('iframe');
            testFrame.src = 'index.html';
            testFrame.style.display = 'none';
            document.body.appendChild(testFrame);
            
            return new Promise((resolve) => {
                testFrame.onload = () => {
                    // Wait a bit for scripts to initialize
                    setTimeout(resolve, 500);
                };
            });
        }

        function getTestFrameWindow() {
            return testFrame.contentWindow;
        }

        function updateSummary() {
            document.getElementById('total-tests').textContent = testResults.total;
            document.getElementById('passed-tests').textContent = testResults.passed;
            document.getElementById('failed-tests').textContent = testResults.failed;
        }

        function addTestResult(containerId, testName, passed, message) {
            testResults.total++;
            if (passed) {
                testResults.passed++;
            } else {
                testResults.failed++;
            }

            const container = document.getElementById(containerId);
            const testCase = document.createElement('div');
            testCase.className = 'test-case';
            
            const testTitle = document.createElement('h3');
            testTitle.textContent = testName;
            testCase.appendChild(testTitle);

            const result = document.createElement('div');
            result.className = `test-result ${passed ? 'pass' : 'fail'}`;
            result.textContent = message;
            testCase.appendChild(result);

            container.appendChild(testCase);
            updateSummary();
        }

        async function testCartOperations() {
            const container = document.getElementById('cart-tests');
            container.innerHTML = '';

            await setupTestFrame();
            const win = getTestFrameWindow();

            // Test 1: Initial cart should be empty
            if (win.cart && win.cart.length === 0) {
                addTestResult('cart-tests', 
                    'Initial Empty Cart', 
                    true, 
                    'âœ… Cart starts empty correctly'
                );
            } else {
                addTestResult('cart-tests', 
                    'Initial Empty Cart', 
                    false, 
                    'âŒ Cart does not start empty'
                );
            }

            // Test 2: Add product to cart
            const initialLength = win.cart.length;
            win.addToCart(1); // Add CafÃ© Americano
            if (win.cart.length === initialLength + 1) {
                addTestResult('cart-tests', 
                    'Add Product to Cart', 
                    true, 
                    'âœ… Product added correctly to cart'
                );
            } else {
                addTestResult('cart-tests', 
                    'Add Product to Cart', 
                    false, 
                    'âŒ Could not add product to cart'
                );
            }

            // Test 3: Add same product increases quantity
            win.addToCart(1); // Add same product again
            if (win.cart[0] && win.cart[0].quantity === 2) {
                addTestResult('cart-tests', 
                    'Increase Product Quantity', 
                    true, 
                    'âœ… Quantity increases when adding the same product'
                );
            } else {
                addTestResult('cart-tests', 
                    'Increase Product Quantity', 
                    false, 
                    'âŒ Quantity does not increase correctly'
                );
            }

            // Test 4: Update quantity manually
            win.updateQuantity(1, 1); // Increase by 1
            if (win.cart[0] && win.cart[0].quantity === 3) {
                addTestResult('cart-tests', 
                    'Update Quantity Manually', 
                    true, 
                    'âœ… Quantity updates correctly with +/- buttons'
                );
            } else {
                addTestResult('cart-tests', 
                    'Update Quantity Manually', 
                    false, 
                    'âŒ Quantity does not update correctly'
                );
            }

            // Test 5: Decrease quantity
            win.updateQuantity(1, -2); // Decrease by 2
            if (win.cart[0] && win.cart[0].quantity === 1) {
                addTestResult('cart-tests', 
                    'Decrease Quantity', 
                    true, 
                    'âœ… Quantity decreases correctly'
                );
            } else {
                addTestResult('cart-tests', 
                    'Decrease Quantity', 
                    false, 
                    'âŒ Quantity does not decrease correctly'
                );
            }

            // Test 6: Remove product when quantity reaches 0
            win.updateQuantity(1, -1); // Should remove product
            if (win.cart.length === 0) {
                addTestResult('cart-tests', 
                    'Remove Product When Quantity Reaches 0', 
                    true, 
                    'âœ… Product is removed when quantity reaches 0'
                );
            } else {
                addTestResult('cart-tests', 
                    'Remove Product When Quantity Reaches 0', 
                    false, 
                    'âŒ Product is not removed correctly'
                );
            }

            // Test 7: Remove product directly
            win.addToCart(1);
            win.removeFromCart(1);
            if (win.cart.length === 0) {
                addTestResult('cart-tests', 
                    'Remove Product Directly', 
                    true, 
                    'âœ… Product is removed correctly with âœ• button'
                );
            } else {
                addTestResult('cart-tests', 
                    'Remove Product Directly', 
                    false, 
                    'âŒ Product is not removed correctly'
                );
            }

            // Test 8: Multiple different products
            win.addToCart(1); // CafÃ© Americano
            win.addToCart(7); // SÃ¡ndwich
            win.addToCart(13); // Brownie
            if (win.cart.length === 3) {
                addTestResult('cart-tests', 
                    'Multiple Different Products', 
                    true, 
                    'âœ… Can add multiple different products'
                );
            } else {
                addTestResult('cart-tests', 
                    'Multiple Different Products', 
                    false, 
                    'âŒ Multiple products not handled correctly'
                );
            }
        }

        async function testCalculations() {
            const container = document.getElementById('calculation-tests');
            container.innerHTML = '';

            await setupTestFrame();
            const win = getTestFrameWindow();

            // Test 1: Single product total
            win.addToCart(1); // CafÃ© Americano - $2,500
            const total1 = win.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            if (total1 === 2500) {
                addTestResult('calculation-tests', 
                    'Total Calculation - Single Product', 
                    true, 
                    'âœ… Total calculated correctly for one product'
                );
            } else {
                addTestResult('calculation-tests', 
                    'Total Calculation - Single Product', 
                    false, 
                    `âŒ Total incorrecto: esperado 2500, obtained ${total1}`
                );
            }

            // Test 2: Multiple quantities of same product
            win.addToCart(1); // Add again
            win.addToCart(1); // And again
            const total2 = win.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            if (total2 === 7500) {
                addTestResult('calculation-tests', 
                    'Total Calculation - Multiple Quantities', 
                    true, 
                    'âœ… Total calculated correctly with multiple quantities'
                );
            } else {
                addTestResult('calculation-tests', 
                    'Total Calculation - Multiple Quantities', 
                    false, 
                    `âŒ Total incorrecto: esperado 7500, obtained ${total2}`
                );
            }

            // Test 3: Multiple different products
            win.cart = []; // Clear cart
            win.addToCart(1); // CafÃ© - $2,500
            win.addToCart(8); // Hamburguesa - $9,000
            win.addToCart(14); // Cheesecake - $4,500
            const total3 = win.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            if (total3 === 16000) {
                addTestResult('calculation-tests', 
                    'Total Calculation - Multiple Products', 
                    true, 
                    'âœ… Total calculated correctly with multiple products'
                );
            } else {
                addTestResult('calculation-tests', 
                    'Total Calculation - Multiple Products', 
                    false, 
                    `âŒ Total incorrecto: esperado 16000, obtained ${total3}`
                );
            }

            // Test 4: Verify product prices are correct
            const product1 = win.findProductById(1);
            const product8 = win.findProductById(8);
            const product14 = win.findProductById(14);
            
            if (product1.price === 2500 && product8.price === 9000 && product14.price === 4500) {
                addTestResult('calculation-tests', 
                    'Product Prices Correct', 
                    true, 
                    'âœ… Product prices are correct'
                );
            } else {
                addTestResult('calculation-tests', 
                    'Product Prices Correct', 
                    false, 
                    'âŒ Some product prices are incorrect'
                );
            }
        }

        async function testPaymentMethods() {
            const container = document.getElementById('payment-tests');
            container.innerHTML = '';

            await setupTestFrame();
            const win = getTestFrameWindow();

            // Test 1: Initial payment selection should be null
            if (win.selectedPayment === null) {
                addTestResult('payment-tests', 
                    'Initial Payment Selection', 
                    true, 
                    'âœ… No payment method selected initially'
                );
            } else {
                addTestResult('payment-tests', 
                    'Initial Payment Selection', 
                    false, 
                    'âŒ There is a default payment method selected'
                );
            }

            // Test 2: Can select payment method
            const mockEvent = { currentTarget: win.document.getElementById('efectivo').parentElement };
            win.selectPayment('efectivo', mockEvent);
            if (win.selectedPayment === 'efectivo') {
                addTestResult('payment-tests', 
                    'Select Payment Method', 
                    true, 
                    'âœ… Can select a payment method'
                );
            } else {
                addTestResult('payment-tests', 
                    'Select Payment Method', 
                    false, 
                    'âŒ Could not select payment method'
                );
            }

            // Test 3: Can change payment method
            const mockEvent2 = { currentTarget: win.document.getElementById('tarjeta').parentElement };
            win.selectPayment('tarjeta', mockEvent2);
            if (win.selectedPayment === 'tarjeta') {
                addTestResult('payment-tests', 
                    'Change Payment Method', 
                    true, 
                    'âœ… Can change payment method'
                );
            } else {
                addTestResult('payment-tests', 
                    'Change Payment Method', 
                    false, 
                    'âŒ Could not change payment method'
                );
            }

            // Test 4: All payment methods available
            const paymentMethods = ['efectivo', 'tarjeta', 'transferencia', 'contra'];
            const allAvailable = paymentMethods.every(method => 
                win.document.getElementById(method) !== null
            );
            
            if (allAvailable) {
                addTestResult('payment-tests', 
                    'Available Payment Methods', 
                    true, 
                    'âœ… All payment methods are available (cash, card, transfer, virtual account)'
                );
            } else {
                addTestResult('payment-tests', 
                    'Available Payment Methods', 
                    false, 
                    'âŒ Some payment methods are missing'
                );
            }
        }

        async function testCheckout() {
            const container = document.getElementById('checkout-tests');
            container.innerHTML = '';

            await setupTestFrame();
            const win = getTestFrameWindow();

            // Test 1: Checkout button disabled when cart empty
            const checkoutBtn = win.document.getElementById('checkout-btn');
            if (checkoutBtn.disabled) {
                addTestResult('checkout-tests', 
                    'Button Disabled with Empty Cart', 
                    true, 
                    'âœ… Checkout button is disabled when cart is empty'
                );
            } else {
                addTestResult('checkout-tests', 
                    'Button Disabled with Empty Cart', 
                    false, 
                    'âŒ Checkout button is not disabled with empty cart'
                );
            }

            // Test 2: Checkout button disabled without payment method
            win.addToCart(1);
            win.updateCart();
            if (checkoutBtn.disabled) {
                addTestResult('checkout-tests', 
                    'Button Disabled without Payment Method', 
                    true, 
                    'âœ… Checkout button is disabled without payment method'
                );
            } else {
                addTestResult('checkout-tests', 
                    'Button Disabled without Payment Method', 
                    false, 
                    'âŒ Checkout button is not disabled without payment method'
                );
            }

            // Test 3: Checkout button enabled with items and payment
            const mockEvent = { currentTarget: win.document.getElementById('efectivo').parentElement };
            win.selectPayment('efectivo', mockEvent);
            if (!checkoutBtn.disabled) {
                addTestResult('checkout-tests', 
                    'Button Enabled with Items and Payment', 
                    true, 
                    'âœ… Checkout button enables with items and payment method'
                );
            } else {
                addTestResult('checkout-tests', 
                    'Button Enabled with Items and Payment', 
                    false, 
                    'âŒ Checkout button does not enable correctly'
                );
            }

            // Test 4: Checkout clears cart
            const cartLength = win.cart.length;
            win.checkout();
            if (win.cart.length === 0 && cartLength > 0) {
                addTestResult('checkout-tests', 
                    'Checkout Clears Cart', 
                    true, 
                    'âœ… Checkout clears cart correctly'
                );
            } else {
                addTestResult('checkout-tests', 
                    'Checkout Clears Cart', 
                    false, 
                    'âŒ Checkout does not clear cart'
                );
            }

            // Test 5: Checkout resets payment selection
            if (win.selectedPayment === null) {
                addTestResult('checkout-tests', 
                    'Checkout Resets Payment Selection', 
                    true, 
                    'âœ… Checkout resets payment selection'
                );
            } else {
                addTestResult('checkout-tests', 
                    'Checkout Resets Payment Selection', 
                    false, 
                    'âŒ Checkout does not reset payment selection'
                );
            }

            // Test 6: Complete order flow
            win.addToCart(1);
            win.addToCart(8);
            const mockEvent2 = { currentTarget: win.document.getElementById('tarjeta').parentElement };
            win.selectPayment('tarjeta', mockEvent2);
            const totalBeforeCheckout = win.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            win.checkout();
            
            if (win.cart.length === 0 && win.selectedPayment === null && totalBeforeCheckout > 0) {
                addTestResult('checkout-tests', 
                    'Complete Order Flow', 
                    true, 
                    'âœ… Complete order flow works correctly'
                );
            } else {
                addTestResult('checkout-tests', 
                    'Complete Order Flow', 
                    false, 
                    'âŒ Complete order flow has errors'
                );
            }
        }

        async function runAllTests() {
            clearResults();
            console.log('ğŸ§ª Starting Functional Test Suite...');
            
            await testCartOperations();
            await testCalculations();
            await testPaymentMethods();
            await testCheckout();

            console.log('âœ… Tests completed!');
            console.log(`Total: ${testResults.total}, Passed: ${testResults.passed}, Failed: ${testResults.failed}`);
            
            // Clean up iframe
            if (testFrame) {
                document.body.removeChild(testFrame);
                testFrame = null;
            }
        }

        function clearResults() {
            testResults = { total: 0, passed: 0, failed: 0 };
            document.getElementById('cart-tests').innerHTML = '';
            document.getElementById('calculation-tests').innerHTML = '';
            document.getElementById('payment-tests').innerHTML = '';
            document.getElementById('checkout-tests').innerHTML = '';
            updateSummary();
        }

        window.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ“‹ Functional Test Suite loaded');
            console.log('Click "Run All Tests" to begin');
        });
    </script>
</body>
</html>
