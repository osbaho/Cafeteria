<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Functional Tests - Virtual Cafeteria</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        .test-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-case {
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 10px 0;
            background: #f9f9f9;
        }
        .test-case h3 {
            margin-top: 0;
            color: #333;
        }
        .test-result {
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px 10px 0;
        }
        button:hover {
            background: #764ba2;
        }
        .summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .summary h2 {
            margin-top: 0;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stat-box {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª Functional Test Suite</h1>
    <p>This tool tests all main features of the Virtual Cafeteria.</p>

    <div class="summary" id="summary">
        <h2>ğŸ“Š Test Summary</h2>
        <div class="stats">
            <div class="stat-box">
                <div class="stat-number" id="total-tests">0</div>
                <div>Total Tests</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="passed-tests">0</div>
                <div>âœ… Passed</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="failed-tests">0</div>
                <div>âŒ Failed</div>
            </div>
        </div>
    </div>

    <button onclick="runAllTests()">â–¶ï¸ Run All Tests</button>
    <button onclick="clearResults()">ğŸ—‘ï¸ Clear Results</button>

    <div class="test-section">
        <h2>ğŸ›’ Cart Management</h2>
        <p>Tests shopping cart operations.</p>
        <div id="cart-tests"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ’° Calculations and Totals</h2>
        <p>Verifies that price calculations are correct.</p>
        <div id="calculation-tests"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ’³ Payment Methods</h2>
        <p>Tests payment method selection.</p>
        <div id="payment-tests"></div>
    </div>

    <div class="test-section">
        <h2>âœ… Checkout Process</h2>
        <p>Verifies the complete order completion process.</p>
        <div id="checkout-tests"></div>
    </div>

    <script>
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0
        };

        // Open index.html in an iframe for testing
        let testFrame;

        function setupTestFrame() {
            // Clean up existing iframe
            if (testFrame) {
                document.body.removeChild(testFrame);
            }
            
            testFrame = document.createElement('iframe');
            testFrame.src = 'index.html';
            testFrame.style.display = 'none';
            document.body.appendChild(testFrame);
            
            return new Promise((resolve) => {
                testFrame.onload = () => {
                    // Wait a bit for scripts to initialize
                    setTimeout(resolve, 500);
                };
            });
        }

        function getTestFrameWindow() {
            return testFrame.contentWindow;
        }

        function updateSummary() {
            document.getElementById('total-tests').textContent = testResults.total;
            document.getElementById('passed-tests').textContent = testResults.passed;
            document.getElementById('failed-tests').textContent = testResults.failed;
        }

        function addTestResult(containerId, testName, passed, message) {
            testResults.total++;
            if (passed) {
                testResults.passed++;
            } else {
                testResults.failed++;
            }

            const container = document.getElementById(containerId);
            const testCase = document.createElement('div');
            testCase.className = 'test-case';
            
            const testTitle = document.createElement('h3');
            testTitle.textContent = testName;
            testCase.appendChild(testTitle);

            const result = document.createElement('div');
            result.className = `test-result ${passed ? 'pass' : 'fail'}`;
            result.textContent = message;
            testCase.appendChild(result);

            container.appendChild(testCase);
            updateSummary();
        }

        async function testCartOperations() {
            const container = document.getElementById('cart-tests');
            container.innerHTML = '';

            await setupTestFrame();
            const win = getTestFrameWindow();

            // Test 1: Initial cart should be empty
            if (win.cart && win.cart.length === 0) {
                addTestResult('cart-tests', 
                    'Carrito Inicial VacÃ­o', 
                    true, 
                    'âœ… El carrito inicia vacÃ­o correctamente'
                );
            } else {
                addTestResult('cart-tests', 
                    'Carrito Inicial VacÃ­o', 
                    false, 
                    'âŒ El carrito no inicia vacÃ­o'
                );
            }

            // Test 2: Add product to cart
            const initialLength = win.cart.length;
            win.addToCart(1); // Add CafÃ© Americano
            if (win.cart.length === initialLength + 1) {
                addTestResult('cart-tests', 
                    'Agregar Producto al Carrito', 
                    true, 
                    'âœ… Producto agregado correctamente al carrito'
                );
            } else {
                addTestResult('cart-tests', 
                    'Agregar Producto al Carrito', 
                    false, 
                    'âŒ No se pudo agregar producto al carrito'
                );
            }

            // Test 3: Add same product increases quantity
            win.addToCart(1); // Add same product again
            if (win.cart[0] && win.cart[0].quantity === 2) {
                addTestResult('cart-tests', 
                    'Incrementar Cantidad de Producto', 
                    true, 
                    'âœ… La cantidad se incrementa al agregar el mismo producto'
                );
            } else {
                addTestResult('cart-tests', 
                    'Incrementar Cantidad de Producto', 
                    false, 
                    'âŒ La cantidad no se incrementa correctamente'
                );
            }

            // Test 4: Update quantity manually
            win.updateQuantity(1, 1); // Increase by 1
            if (win.cart[0] && win.cart[0].quantity === 3) {
                addTestResult('cart-tests', 
                    'Actualizar Cantidad Manualmente', 
                    true, 
                    'âœ… La cantidad se actualiza correctamente con los botones +/-'
                );
            } else {
                addTestResult('cart-tests', 
                    'Actualizar Cantidad Manualmente', 
                    false, 
                    'âŒ La cantidad no se actualiza correctamente'
                );
            }

            // Test 5: Decrease quantity
            win.updateQuantity(1, -2); // Decrease by 2
            if (win.cart[0] && win.cart[0].quantity === 1) {
                addTestResult('cart-tests', 
                    'Disminuir Cantidad', 
                    true, 
                    'âœ… La cantidad disminuye correctamente'
                );
            } else {
                addTestResult('cart-tests', 
                    'Disminuir Cantidad', 
                    false, 
                    'âŒ La cantidad no disminuye correctamente'
                );
            }

            // Test 6: Remove product when quantity reaches 0
            win.updateQuantity(1, -1); // Should remove product
            if (win.cart.length === 0) {
                addTestResult('cart-tests', 
                    'Eliminar Producto al Llegar a Cantidad 0', 
                    true, 
                    'âœ… El producto se elimina cuando la cantidad llega a 0'
                );
            } else {
                addTestResult('cart-tests', 
                    'Eliminar Producto al Llegar a Cantidad 0', 
                    false, 
                    'âŒ El producto no se elimina correctamente'
                );
            }

            // Test 7: Remove product directly
            win.addToCart(1);
            win.removeFromCart(1);
            if (win.cart.length === 0) {
                addTestResult('cart-tests', 
                    'Eliminar Producto Directamente', 
                    true, 
                    'âœ… El producto se elimina correctamente con el botÃ³n âœ•'
                );
            } else {
                addTestResult('cart-tests', 
                    'Eliminar Producto Directamente', 
                    false, 
                    'âŒ El producto no se elimina correctamente'
                );
            }

            // Test 8: Multiple different products
            win.addToCart(1); // CafÃ© Americano
            win.addToCart(7); // SÃ¡ndwich
            win.addToCart(13); // Brownie
            if (win.cart.length === 3) {
                addTestResult('cart-tests', 
                    'MÃºltiples Productos Diferentes', 
                    true, 
                    'âœ… Se pueden agregar mÃºltiples productos diferentes'
                );
            } else {
                addTestResult('cart-tests', 
                    'MÃºltiples Productos Diferentes', 
                    false, 
                    'âŒ No se manejan correctamente mÃºltiples productos'
                );
            }
        }

        async function testCalculations() {
            const container = document.getElementById('calculation-tests');
            container.innerHTML = '';

            await setupTestFrame();
            const win = getTestFrameWindow();

            // Test 1: Single product total
            win.addToCart(1); // CafÃ© Americano - $2,500
            const total1 = win.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            if (total1 === 2500) {
                addTestResult('calculation-tests', 
                    'CÃ¡lculo de Total - Producto Ãšnico', 
                    true, 
                    'âœ… El total se calcula correctamente para un producto'
                );
            } else {
                addTestResult('calculation-tests', 
                    'CÃ¡lculo de Total - Producto Ãšnico', 
                    false, 
                    `âŒ Total incorrecto: esperado 2500, obtenido ${total1}`
                );
            }

            // Test 2: Multiple quantities of same product
            win.addToCart(1); // Add again
            win.addToCart(1); // And again
            const total2 = win.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            if (total2 === 7500) {
                addTestResult('calculation-tests', 
                    'CÃ¡lculo de Total - MÃºltiples Cantidades', 
                    true, 
                    'âœ… El total se calcula correctamente con mÃºltiples cantidades'
                );
            } else {
                addTestResult('calculation-tests', 
                    'CÃ¡lculo de Total - MÃºltiples Cantidades', 
                    false, 
                    `âŒ Total incorrecto: esperado 7500, obtenido ${total2}`
                );
            }

            // Test 3: Multiple different products
            win.cart = []; // Clear cart
            win.addToCart(1); // CafÃ© - $2,500
            win.addToCart(8); // Hamburguesa - $9,000
            win.addToCart(14); // Cheesecake - $4,500
            const total3 = win.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            if (total3 === 16000) {
                addTestResult('calculation-tests', 
                    'CÃ¡lculo de Total - MÃºltiples Productos', 
                    true, 
                    'âœ… El total se calcula correctamente con mÃºltiples productos'
                );
            } else {
                addTestResult('calculation-tests', 
                    'CÃ¡lculo de Total - MÃºltiples Productos', 
                    false, 
                    `âŒ Total incorrecto: esperado 16000, obtenido ${total3}`
                );
            }

            // Test 4: Verify product prices are correct
            const product1 = win.findProductById(1);
            const product8 = win.findProductById(8);
            const product14 = win.findProductById(14);
            
            if (product1.price === 2500 && product8.price === 9000 && product14.price === 4500) {
                addTestResult('calculation-tests', 
                    'Precios de Productos Correctos', 
                    true, 
                    'âœ… Los precios de los productos son correctos'
                );
            } else {
                addTestResult('calculation-tests', 
                    'Precios de Productos Correctos', 
                    false, 
                    'âŒ Algunos precios de productos son incorrectos'
                );
            }
        }

        async function testPaymentMethods() {
            const container = document.getElementById('payment-tests');
            container.innerHTML = '';

            await setupTestFrame();
            const win = getTestFrameWindow();

            // Test 1: Initial payment selection should be null
            if (win.selectedPayment === null) {
                addTestResult('payment-tests', 
                    'SelecciÃ³n de Pago Inicial', 
                    true, 
                    'âœ… No hay mÃ©todo de pago seleccionado inicialmente'
                );
            } else {
                addTestResult('payment-tests', 
                    'SelecciÃ³n de Pago Inicial', 
                    false, 
                    'âŒ Hay un mÃ©todo de pago seleccionado por defecto'
                );
            }

            // Test 2: Can select payment method
            const mockEvent = { currentTarget: win.document.getElementById('efectivo').parentElement };
            win.selectPayment('efectivo', mockEvent);
            if (win.selectedPayment === 'efectivo') {
                addTestResult('payment-tests', 
                    'Seleccionar MÃ©todo de Pago', 
                    true, 
                    'âœ… Se puede seleccionar un mÃ©todo de pago'
                );
            } else {
                addTestResult('payment-tests', 
                    'Seleccionar MÃ©todo de Pago', 
                    false, 
                    'âŒ No se pudo seleccionar mÃ©todo de pago'
                );
            }

            // Test 3: Can change payment method
            const mockEvent2 = { currentTarget: win.document.getElementById('tarjeta').parentElement };
            win.selectPayment('tarjeta', mockEvent2);
            if (win.selectedPayment === 'tarjeta') {
                addTestResult('payment-tests', 
                    'Cambiar MÃ©todo de Pago', 
                    true, 
                    'âœ… Se puede cambiar el mÃ©todo de pago'
                );
            } else {
                addTestResult('payment-tests', 
                    'Cambiar MÃ©todo de Pago', 
                    false, 
                    'âŒ No se pudo cambiar el mÃ©todo de pago'
                );
            }

            // Test 4: All payment methods available
            const paymentMethods = ['efectivo', 'tarjeta', 'transferencia', 'contra'];
            const allAvailable = paymentMethods.every(method => 
                win.document.getElementById(method) !== null
            );
            
            if (allAvailable) {
                addTestResult('payment-tests', 
                    'MÃ©todos de Pago Disponibles', 
                    true, 
                    'âœ… Todos los mÃ©todos de pago estÃ¡n disponibles (efectivo, tarjeta, transferencia, contra)'
                );
            } else {
                addTestResult('payment-tests', 
                    'MÃ©todos de Pago Disponibles', 
                    false, 
                    'âŒ Faltan algunos mÃ©todos de pago'
                );
            }
        }

        async function testCheckout() {
            const container = document.getElementById('checkout-tests');
            container.innerHTML = '';

            await setupTestFrame();
            const win = getTestFrameWindow();

            // Test 1: Checkout button disabled when cart empty
            const checkoutBtn = win.document.getElementById('checkout-btn');
            if (checkoutBtn.disabled) {
                addTestResult('checkout-tests', 
                    'BotÃ³n Deshabilitado con Carrito VacÃ­o', 
                    true, 
                    'âœ… El botÃ³n de checkout estÃ¡ deshabilitado cuando el carrito estÃ¡ vacÃ­o'
                );
            } else {
                addTestResult('checkout-tests', 
                    'BotÃ³n Deshabilitado con Carrito VacÃ­o', 
                    false, 
                    'âŒ El botÃ³n de checkout no estÃ¡ deshabilitado con carrito vacÃ­o'
                );
            }

            // Test 2: Checkout button disabled without payment method
            win.addToCart(1);
            win.updateCart();
            if (checkoutBtn.disabled) {
                addTestResult('checkout-tests', 
                    'BotÃ³n Deshabilitado sin MÃ©todo de Pago', 
                    true, 
                    'âœ… El botÃ³n de checkout estÃ¡ deshabilitado sin mÃ©todo de pago'
                );
            } else {
                addTestResult('checkout-tests', 
                    'BotÃ³n Deshabilitado sin MÃ©todo de Pago', 
                    false, 
                    'âŒ El botÃ³n de checkout no se deshabilita sin mÃ©todo de pago'
                );
            }

            // Test 3: Checkout button enabled with items and payment
            const mockEvent = { currentTarget: win.document.getElementById('efectivo').parentElement };
            win.selectPayment('efectivo', mockEvent);
            if (!checkoutBtn.disabled) {
                addTestResult('checkout-tests', 
                    'BotÃ³n Habilitado con Items y Pago', 
                    true, 
                    'âœ… El botÃ³n de checkout se habilita con items y mÃ©todo de pago'
                );
            } else {
                addTestResult('checkout-tests', 
                    'BotÃ³n Habilitado con Items y Pago', 
                    false, 
                    'âŒ El botÃ³n de checkout no se habilita correctamente'
                );
            }

            // Test 4: Checkout clears cart
            const cartLength = win.cart.length;
            win.checkout();
            if (win.cart.length === 0 && cartLength > 0) {
                addTestResult('checkout-tests', 
                    'Checkout Limpia el Carrito', 
                    true, 
                    'âœ… El checkout limpia el carrito correctamente'
                );
            } else {
                addTestResult('checkout-tests', 
                    'Checkout Limpia el Carrito', 
                    false, 
                    'âŒ El checkout no limpia el carrito'
                );
            }

            // Test 5: Checkout resets payment selection
            if (win.selectedPayment === null) {
                addTestResult('checkout-tests', 
                    'Checkout Resetea SelecciÃ³n de Pago', 
                    true, 
                    'âœ… El checkout resetea la selecciÃ³n de pago'
                );
            } else {
                addTestResult('checkout-tests', 
                    'Checkout Resetea SelecciÃ³n de Pago', 
                    false, 
                    'âŒ El checkout no resetea la selecciÃ³n de pago'
                );
            }

            // Test 6: Complete order flow
            win.addToCart(1);
            win.addToCart(8);
            const mockEvent2 = { currentTarget: win.document.getElementById('tarjeta').parentElement };
            win.selectPayment('tarjeta', mockEvent2);
            const totalBeforeCheckout = win.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            win.checkout();
            
            if (win.cart.length === 0 && win.selectedPayment === null && totalBeforeCheckout > 0) {
                addTestResult('checkout-tests', 
                    'Flujo Completo de Pedido', 
                    true, 
                    'âœ… El flujo completo de pedido funciona correctamente'
                );
            } else {
                addTestResult('checkout-tests', 
                    'Flujo Completo de Pedido', 
                    false, 
                    'âŒ El flujo completo de pedido tiene errores'
                );
            }
        }

        async function runAllTests() {
            clearResults();
            console.log('ğŸ§ª Starting Functional Test Suite...');
            
            await testCartOperations();
            await testCalculations();
            await testPaymentMethods();
            await testCheckout();

            console.log('âœ… Tests completed!');
            console.log(`Total: ${testResults.total}, Passed: ${testResults.passed}, Failed: ${testResults.failed}`);
            
            // Clean up iframe
            if (testFrame) {
                document.body.removeChild(testFrame);
                testFrame = null;
            }
        }

        function clearResults() {
            testResults = { total: 0, passed: 0, failed: 0 };
            document.getElementById('cart-tests').innerHTML = '';
            document.getElementById('calculation-tests').innerHTML = '';
            document.getElementById('payment-tests').innerHTML = '';
            document.getElementById('checkout-tests').innerHTML = '';
            updateSummary();
        }

        window.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ“‹ Functional Test Suite loaded');
            console.log('Click "Run All Tests" to begin');
        });
    </script>
</body>
</html>
